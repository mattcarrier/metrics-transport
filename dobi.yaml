meta:
  project: metrics-transport
  default: build

image=gradle:
  image:  gradle
  tags:   [ 3.4-jdk8-alpine ]
  pull:   always

image=dockerize:
  image:  jwilder/dockerize
  tags:   [ latest ] 
  pull:   always

mount=kitchen-sink:
  bind: .
  path: /opt/metrics-rabbit

job=ossrh-release:
  use:          gradle
  mounts:       [ kitchen-sink ]
  working-dir:  /opt/metrics-rabbit
  net-mode:     inttestenv_default
  command:      gradle uploadArchives closeAndReleaseRepository
  env:          [ 
    "ORG_GRADLE_PROJECT_rabbitHost=rabbit",
    "ORG_GRADLE_PROJECT_ossrhUsername={env.ossrhUsername}",
    "ORG_GRADLE_PROJECT_ossrhPassword={env.ossrhPassword}",
    "ORG_GRADLE_PROJECT_signing.keyId={env.signingKeyId}",
    "ORG_GRADLE_PROJECT_signing.password={env.signingPassword}",
    "ORG_GRADLE_PROJECT_signing.secretKeyRingFile={env.signingSecretKeyRingFile:../secring.gpg}"
  ]

job=ossrh-upload:
  use:          gradle
  mounts:       [ kitchen-sink ]
  working-dir:  /opt/metrics-rabbit
  net-mode:     inttestenv_default
  command:      gradle uploadArchives
  env:          [ 
    "ORG_GRADLE_PROJECT_rabbitHost=rabbit",
    "ORG_GRADLE_PROJECT_ossrhUsername={env.ossrhUsername}",
    "ORG_GRADLE_PROJECT_ossrhPassword={env.ossrhPassword}",
    "ORG_GRADLE_PROJECT_signing.keyId={env.signingKeyId}",
    "ORG_GRADLE_PROJECT_signing.password={env.signingPassword}",
    "ORG_GRADLE_PROJECT_signing.secretKeyRingFile={env.signingSecretKeyRingFile:../secring.gpg}"
  ]

job=gradle-build:
  use:          gradle
  mounts:       [ kitchen-sink ]
  working-dir:  /opt/metrics-rabbit
  net-mode:     inttestenv_default
  command:      gradle license build
  env:          [ 
    "ORG_GRADLE_PROJECT_rabbitHost=rabbit",
    "ORG_GRADLE_PROJECT_ossrhUsername={env.ossrhUsername:}",
    "ORG_GRADLE_PROJECT_ossrhPassword={env.ossrhPassword:}",
    "ORG_GRADLE_PROJECT_signing.keyId="
  ]

job=wait-for-rabbit:
  use:      dockerize
  net-mode: inttestenv_default
  command:  'dockerize -wait tcp://rabbit:5672 -timeout 1m'

compose=int-test-env:
  files:    [ docker-compose.yml ]
  project:  'inttestenv'

alias=build:
  tasks: [ int-test-env, wait-for-rabbit, gradle-build ]

alias=deploy:
  tasks: [ build, ossrh-upload ]

alias=release:
  tasks: [ build, ossrh-release ]
