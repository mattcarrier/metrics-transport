meta:
  project: metrics-transport
  default: build

image=maven:
  image:    metrics-transport-maven
  context:  dobi/ossrh

image=dockerize:
  image:  jwilder/dockerize
  tags:   [ latest ]
  pull:   always

mount=kitchen-sink:
  bind: .
  path: /opt/metrics-transport

mount=maven-settings:
  bind: maven/settings.xml
  path: /usr/share/maven/conf/settings.xml

job=ossrh-upload:
  use:          maven
  mounts:       [
    kitchen-sink,
    maven-settings
  ]
  working-dir:  /opt/metrics-transport
  net-mode:     inttestenv_default
  command:      mvn -P ossrh deploy
  env:          [
    "RABBIT_HOST=rabbit",
    "OSSRH_USERNAME={env.OSSRH_USERNAME}",
    "OSSRH_PASSWORD={env.OSSRH_PASSWORD}",
    "SIGNING_PASSPHRASE={env.SIGNING_PASSPHRASE}"
  ]

job=maven-build:
  use:          maven
  mounts:       [
    kitchen-sink,
    maven-settings
  ]
  working-dir:  /opt/metrics-transport
  net-mode:     inttestenv_default
  command:      mvn clean verify
  env:          [
    "RABBIT_HOST=rabbit"
  ]

job=wait-for-rabbit:
  use:      dockerize
  net-mode: inttestenv_default
  command:  'dockerize -wait tcp://rabbit:5672 -timeout 1m'

compose=int-test-env:
  files:    [ docker-compose.yml ]
  project:  'inttestenv'

alias=build:
  tasks: [ int-test-env, wait-for-rabbit, maven-build ]

alias=deploy:
  tasks: [ build, ossrh-upload ]
